# E2E Tests

実際のTodoist APIを使用したEnd-to-Endテスト。CLIコマンドを通じてシステム全体の動作を検証します。

## 方針

E2Eテストは、ユーザーが実際に使用するCLIコマンドを通じてシステム全体の動作を確認します。
APIクライアントの直接テストではなく、CLIコマンドの実行結果を検証することで、より実践的なテストを実現しています。

## 実行方法

### 前提条件
- `TODOIST_API_TOKEN` 環境変数の設定が必要
- テスト用のTodoistアカウント（実際のデータが変更される可能性があります）
- Todoistの無料プランの場合、プロジェクト数に制限があります（通常5個）

### ローカル実行
```bash
# E2Eテストのみ実行
make test-e2e

# または直接実行
TODOIST_API_TOKEN=your_token go test -tags=e2e ./e2e/...

# verbose出力付き
TODOIST_API_TOKEN=your_token go test -v -tags=e2e ./e2e/...
```

### CI実行
GitHub ActionsのCIでは自動的に実行されます（`TODOIST_API_TOKEN` secretが設定されている場合）。

## テスト内容

### TestProjectLifecycle
プロジェクトとタスクのライフサイクル全体をテストし、データ整合性を検証します。

#### テストシナリオ
1. **ベースラインデータ取得**
   - `sync reset -f`: ローカルストレージをリセット
   - `sync`: サーバーからデータを同期
   - ベースラインとなるプロジェクト/タスク一覧を記録

2. **プロジェクト作成・更新**
   - `project add`: 新規プロジェクト作成
   - `project list`: 作成確認
   - `project update --name`: プロジェクト名更新

3. **タスク操作**
   - `task add -p`: プロジェクトに3つのタスク追加
   - `task list -p`: タスク一覧確認
   - `task update --content`: タスク内容更新
   - `task delete -f`: タスク削除

4. **プロジェクトアーカイブ**
   - `project archive`: プロジェクトをアーカイブ
   - `project list`: アクティブ一覧から消えることを確認
   - `project unarchive`: プロジェクトを復活
   - タスクも再表示されることを確認

5. **プロジェクト削除とカスケード削除**
   - `project delete -f`: プロジェクト削除
   - `sync`: 同期実行
   - `task list`: 関連タスクも削除されていることを確認

6. **データ整合性確認**
   - `sync reset -f`: 再度リセット
   - `sync`: 再同期
   - ベースラインデータと最終データが一致することを確認

### 検証内容
- ローカルストレージとTodoist APIサーバー間の同期
- プロジェクト削除時のカスケード削除
- アーカイブ/アンアーカイブの状態変更
- sync reset機能の動作確認
- コマンドの正しい動作とエラーハンドリング

## 注意事項
- テストは実際のTodoist APIに対して実行されます
- テスト実行時に一時的なプロジェクトとタスクが作成されます
- テストは隔離された一時ディレクトリで実行されるため、既存の設定には影響しません
- APIメンテナンス中はテストが失敗する可能性があります（HTTP 503）
- レート制限に注意してください